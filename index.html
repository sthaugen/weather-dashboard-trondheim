<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="fonts/material-symbols-outlined.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preconnect" href="https://api.open-meteo.com" crossorigin>

    <style>
        /* Local Material Symbols Font */
        @font-face {
            font-family: 'Material Symbols Outlined';
            font-style: normal;
            font-weight: 100 700;
            font-display: swap;
            src: url(fonts/material-symbols-outlined.woff2) format('woff2');
        }

        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            font-feature-settings: 'liga';
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }

        .dashboard {
            width: 800px;
            height: 480px;
            overflow: hidden;
            background: white;
            padding: 5px;
            display: grid;
            grid-template-columns: 1.7fr 1fr;
            gap: 10px;
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .top-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .current-weather {
            display: flex;
            flex-direction: column;
            gap: 0px;
        }

        .temp-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 25px;
        }

        .temp-main {
            font-size: 65px;
            font-weight: 800;
            color: #333;
            line-height: 1;
        }

        .render-timestamp {
            font-size: 15px;
            color: #333;
            font-weight: normal;
            margin-top: 5px;
            display: block;
            text-align: left;
        }

        .weather-icon {
            width: 70px;
            height: 70px;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .detail-item {
            padding: 6px 0px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .temp-display .detail-item {
            align-items: flex-start;
        }

        .detail-label {
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 800;
            text-decoration: underline;
        }

        .detail-value {
            color: #333;
            font-size: 22px;
            font-weight: 800;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sun-moon {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .info-card {
            padding: 6px 0px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-label {
            font-size: 14px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 800;
            text-decoration: underline;
        }

        .info-value {
            font-size: 18px;
            font-weight: 800;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .radar-section {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-bottom: 5px;
        }

        .radar-map {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            overflow: hidden;
            position: relative;
            border-radius: 10px;
            /* border: 1px solid #333; */
        }

        .radar-map iframe {
            width: 100%;
            height: 130%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }

        .forecast-section {
            padding-top: 10px;
        }

        .forecast-title {
            font-size: 20px;
            font-weight: 800;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .forecast-title::before,
        .forecast-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background-color: #333;
        }

        .forecast-days {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
        }

        .forecast-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 7px;
            padding: 3px;
            text-align: center;
        }

        .forecast-date {
            font-size: 20px;
            color: #333;
            font-weight: 800;
        }

        .forecast-icon {
            width: 32px;
            height: 32px;
        }

        .forecast-condition {
            font-size: 15px;
            color: #333;
            line-height: 1.2;
            font-weight: 700;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .forecast-temp {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            display: block;
        }

        .forecast-temp-low {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            display: block;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 20px;
            margin: 8px 0;
        }

        .skeleton-temp {
            height: 60px;
            width: 150px;
            margin-bottom: 15px;
        }

        .skeleton-icon {
            height: 70px;
            width: 70px;
            border-radius: 50%;
        }

        .skeleton-card {
            height: 80px;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="dashboard" id="dashboard">
        <div class="left-section">
            <div class="current-weather">
                <div class="temp-display" style="position: relative;">
                    <div class="skeleton skeleton-temp"></div>
                    <div class="skeleton skeleton-icon"></div>
                    <div class="detail-item">
                        <div class="skeleton skeleton-text" style="width: 80px; height: 24px;"></div>
                        <div class="render-timestamp" id="renderTimestamp" style="align-self: flex-start;">Loading...</div>
                    </div>
                </div>
                <div class="weather-details">
                    <div class="detail-item"><div class="skeleton skeleton-card"></div></div>
                    <div class="detail-item"><div class="skeleton skeleton-card"></div></div>
                    <div class="detail-item"><div class="skeleton skeleton-card"></div></div>
                </div>
                <div class="sun-moon">
                    <div class="info-card"><div class="skeleton skeleton-card"></div></div>
                    <div class="info-card"><div class="skeleton skeleton-card"></div></div>
                    <div class="info-card"><div class="skeleton skeleton-card"></div></div>
                </div>
            </div>
            <div class="forecast-section">
                <div class="forecast-title">4-Day Forecast</div>
                <div class="forecast-days">
                    <div class="forecast-day"><div class="skeleton" style="height: 120px;"></div></div>
                    <div class="forecast-day"><div class="skeleton" style="height: 120px;"></div></div>
                    <div class="forecast-day"><div class="skeleton" style="height: 120px;"></div></div>
                    <div class="forecast-day"><div class="skeleton" style="height: 120px;"></div></div>
                </div>
            </div>
        </div>
        <div class="radar-section">
            <div class="radar-map">
                <div class="skeleton" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>

    <script>
        const LOCATION = 'Trondheim';
        // 26.0 N, 50.5577 E
        const LAT = 63.4305;
        const LON = 10.3951;
        const CACHE_KEY = 'weather_cache';
        const CACHE_DURATION = 10 * 60 * 1000; // 10 minutes

        // Signal when content is ready for e-paper display capture
        function markAsReady() {
            document.body.setAttribute('data-weather-ready', 'true');
            document.body.classList.add('weather-loaded');
        }

        // Load cached data immediately on page load
        function loadCachedWeather() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    const age = Date.now() - timestamp;

                    if (age < CACHE_DURATION) {
                        // Cache is still valid, display immediately
                        displayWeather(data, 'Trondheim', 'Norway', LAT, LON);
                        markAsReady();
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error loading cache:', error);
            }
            return false;
        }

        async function fetchWeather() {
            try {
                // Fetch weather data from Open-Meteo (no geocoding needed!)
                const weatherResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max&timezone=auto&forecast_days=4`
                );
                const weatherData = await weatherResponse.json();

                // Cache the data
                localStorage.setItem(CACHE_KEY, JSON.stringify({
                    data: weatherData,
                    timestamp: Date.now()
                }));

                displayWeather(weatherData, 'Trondheim', 'Norway', LAT, LON);
                markAsReady();
            } catch (error) {
                console.error('Error fetching weather:', error);
                document.getElementById('dashboard').innerHTML =
                    `<div style="text-align: center; padding: 40px; color: #888;">Error loading weather data. Please refresh.</div>`;
            }
        }

        function calculateMoonPhase(date = new Date()) {
            let year = date.getFullYear();
            let month = date.getMonth() + 1;
            const day = date.getDate();

            let c = 0, e = 0, jd = 0, b = 0;

            if (month < 3) {
                year--;
                month += 12;
            }

            ++month;
            c = 365.25 * year;
            e = 30.6 * month;
            jd = c + e + day - 694039.09;
            jd /= 29.5305882;
            b = parseInt(jd);
            jd -= b;
            b = Math.round(jd * 8);

            if (b >= 8) b = 0;

            const phases = [
                { name: 'New Moon', icon: 'brightness_1' },
                { name: 'Waxing Crescent', icon: 'nightlight' },
                { name: 'First Quarter', icon: 'nightlight_round' },
                { name: 'Waxing Gibbous', icon: 'bedtime' },
                { name: 'Full Moon', icon: 'circle' },
                { name: 'Waning Gibbous', icon: 'bedtime' },
                { name: 'Last Quarter', icon: 'nightlight_round' },
                { name: 'Waning Crescent', icon: 'nightlight' }
            ];

            return phases[b];
        }

        function getWeatherIcon(code) {
            // Map to Google Material Symbol icon names
            const icons = {
                0: 'clear_day',           // Clear sky
                1: 'partly_cloudy_day',   // Mainly clear
                2: 'partly_cloudy_day',   // Partly cloudy
                3: 'cloud',               // Overcast
                45: 'foggy',              // Fog
                48: 'foggy',              // Rime fog
                51: 'rainy_light',        // Light drizzle
                53: 'rainy',              // Drizzle
                55: 'rainy',              // Heavy drizzle
                61: 'rainy_light',        // Light rain
                63: 'rainy',              // Rain
                65: 'rainy_heavy',        // Heavy rain
                71: 'weather_snowy',      // Light snow
                73: 'weather_snowy',      // Snow
                75: 'weather_snowy',      // Heavy snow
                80: 'rainy',              // Light showers
                81: 'rainy',              // Showers
                82: 'rainy_heavy',        // Heavy showers
                95: 'thunderstorm',       // Thunderstorm
                96: 'thunderstorm',       // Thunderstorm
                99: 'thunderstorm'        // Thunderstorm
            };
            return icons[code] || 'clear_day';
        }

        function getWeatherDescription(code) {
            const descriptions = {
                0: 'Clear', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Cloudy',
                45: 'Foggy', 48: 'Foggy',
                51: 'Light Drizzle', 53: 'Drizzle', 55: 'Heavy Drizzle',
                61: 'Light Rain', 63: 'Rain', 65: 'Heavy Rain',
                71: 'Light Snow', 73: 'Snow', 75: 'Heavy Snow',
                80: 'Light Showers', 81: 'Showers', 82: 'Heavy Showers',
                95: 'Thunderstorm', 96: 'Thunderstorm', 99: 'Thunderstorm'
            };
            return descriptions[code] || 'Clear';
        }

        function formatTime(timeStr) {
            if (!timeStr) return 'N/A';
            return timeStr.split('T')[1]?.substring(0, 5) || timeStr;
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return days[date.getDay()];
        }

        function displayWeather(data, locationName, country, lat, lon) {
            const { current, daily } = data;
            const moonPhase = calculateMoonPhase();

            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                <div class="left-section">
                    <div class="current-weather">
                        <div class="temp-display">
                            <div class="temp-main">${Math.round(current.temperature_2m)}°</div>
                            <span class="material-symbols-outlined weather-icon" style="font-size: 70px; color: #F57C00;">${getWeatherIcon(current.weather_code)}</span>
                            <div class="detail-item">
                                <span class="detail-value">${getWeatherDescription(current.weather_code)}</span>
                                <div class="render-timestamp" id="renderTimestamp"></div>
                            </div>
                        </div>

                        <div class="weather-details">
                            <div class="detail-item">
                                <div class="detail-label">Feels Like</div>
                                <span class="material-symbols-outlined" style="font-size: 35px; color: #F57C00; display: block; margin: 4px 0;">thermostat</span>
                                <div class="detail-value">${Math.round(current.apparent_temperature)}°C</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Humidity</div>
                                <span class="material-symbols-outlined" style="font-size: 35px; color: #F57C00; display: block; margin: 4px 0;">humidity_percentage</span>
                                <div class="detail-value">${current.relative_humidity_2m}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Wind</div>
                                <span class="material-symbols-outlined" style="font-size: 35px; color: #F57C00; display: block; margin: 4px 0; transform: rotate(${current.wind_direction_10m}deg);">arrow_upward</span>
                                <div class="detail-value">${Math.round(current.wind_speed_10m/3.6)} m/s</div>
                            </div>
                        </div>

                        <div class="sun-moon">
                            <div class="info-card">
                                <div class="info-label">Sunrise</div>
                                <span class="material-symbols-outlined" style="font-size: 35px; color: #F57C00; display: block; margin: 4px 0;">wb_twilight</span>
                                <div class="info-value">${formatTime(daily.sunrise[0])}</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Sunset</div>
                                <span class="material-symbols-outlined" style="font-size: 35px; color: #F57C00; display: block; margin: 4px 0;">wb_twilight</span>
                                <div class="info-value">${formatTime(daily.sunset[0])}</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Moon Phase</div>
                                <span class="material-symbols-outlined" style="font-size: 35px; color: #F57C00; display: block; margin: 4px 0;">${moonPhase.icon}</span>
                                <div class="info-value">${moonPhase.name}</div>
                            </div>
                        </div>
                    </div>

                    <div class="forecast-section">
                        <div class="forecast-title">4-Day Forecast</div>
                        <div class="forecast-days">
                            ${daily.time.slice(0, 4).map((date, index) => `
                                <div class="forecast-day">
                                    <span class="forecast-date">${formatDateShort(date)}</span>
                                    <span class="material-symbols-outlined" style="font-size: 50px; color: #F57C00;">${getWeatherIcon(daily.weather_code[index])}</span>
                                    <span class="forecast-condition">${getWeatherDescription(daily.weather_code[index])}</span>
                                    <div>
                                        <span class="forecast-temp">${Math.round(daily.temperature_2m_max[index])}°</span>
                                        <span class="forecast-temp-low"> ${Math.round(daily.temperature_2m_min[index])}°</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="radar-section">
                    <div class="radar-map">
                        <iframe loading="lazy"
                            src="https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&width=650&height=450&zoom=8&level=surface&overlay=rain&product=ecmwf&menu=&message=&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=°C">
                        frameborder="0">
                        </iframe>
                    </div>
                </div>
            `;
        }

        // Load cached data immediately, then fetch fresh data
        const hasCachedData = loadCachedWeather();

        // Always fetch fresh data in background
        fetchWeather();

        // Refresh every 10 minutes
        setInterval(fetchWeather, 600000);
    </script>
</body>
</html>
